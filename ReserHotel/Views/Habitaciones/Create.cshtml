@model ReserHotel.Models.DTOs.HabitacionDto
@using HotelSystem.Domain.Entities
@{
 ViewData["Title"] = "Nueva Habitación";
}
<div class="container mt-4">
 <h2>Nueva Habitación</h2>
 <form asp-action="Create" method="post" class="row g-3" id="FormCrearHab">
 <!-- hidden fields to persist quote -->
 <input type="hidden" name="CotzEntrada" id="CotzEntradaHidden" />
 <input type="hidden" name="CotzSalida" id="CotzSalidaHidden" />
 <div class="col-md-4">
 <label asp-for="HotelId" class="form-label"></label>
 <select asp-for="HotelId" asp-items="ViewBag.Hoteles" class="form-select" id="HotelId"></select>
 <span asp-validation-for="HotelId" class="text-danger"></span>
 </div>
 <div class="col-md-4">
 <label for="Numero" class="form-label">Habitaciones disponibles</label>
 <select asp-for="Numero" class="form-select" id="Numero">
 <option value="">-- seleccione tipo y hotel --</option>
 </select>
 <span class="form-text">Aparecen solo números disponibles para el hotel y tipo.</span>
 <span asp-validation-for="Numero" class="text-danger"></span>
 </div>
 <div class="col-md-4">
 <label class="form-label">Habitaciones ocupadas</label>
 <select id="Ocupadas" class="form-select" multiple disabled size="4">
 <option>(sin datos)</option>
 </select>
 <input asp-for="Piso" type="hidden" id="Piso" />
 <span asp-validation-for="Piso" class="text-danger"></span>
 </div>
 <div class="col-md-4">
 <label asp-for="Tipo" class="form-label"></label>
 <select asp-for="Tipo" class="form-select" asp-items="Html.GetEnumSelectList<TipoHabitacion>()" id="Tipo"></select>
 <span asp-validation-for="Tipo" class="text-danger"></span>
 </div>
 <div class="col-md-4">
 <label asp-for="Capacidad" class="form-label"></label>
 <input asp-for="Capacidad" class="form-control" />
 <span asp-validation-for="Capacidad" class="text-danger"></span>
 </div>

 <!-- Nombre + DNI en la misma fila -->
 <div class="col-12">
 <div class="row g-3">
 <div class="col-md-8">
 <label asp-for="RegistradoNombreCompleto" class="form-label"></label>
 <input asp-for="RegistradoNombreCompleto" class="form-control" />
 <span asp-validation-for="RegistradoNombreCompleto" class="text-danger"></span>
 </div>
 <div class="col-md-4">
 <label asp-for="RegistradoDni" class="form-label"></label>
 <input asp-for="RegistradoDni" class="form-control" />
 <span asp-validation-for="RegistradoDni" class="text-danger"></span>
 </div>
 </div>
 </div>

 <div class="col-md-12">
 <label asp-for="Amenidades" class="form-label"></label>
 <textarea asp-for="Amenidades" class="form-control" rows="3" id="Amenidades"></textarea>
 <span asp-validation-for="Amenidades" class="text-danger"></span>
 </div>

 <!-- Cotización en vivo para referencia del encargado -->
 <div class="col-12"><h5>Cotización (referencia)</h5></div>
 <div class="col-md-3">
 <label class="form-label">Entrada</label>
 <input id="CotzEntrada" type="date" class="form-control" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
 </div>
 <div class="col-md-3">
 <label class="form-label">Salida</label>
 <input id="CotzSalida" type="date" class="form-control" min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" />
 </div>
 <div class="col-md-6">
 <label class="form-label">Servicios del hotel</label>
 <div id="ServiciosHotel" class="d-flex flex-wrap gap-3 align-items-center"></div>
 <small class="text-muted d-block">Marque o desmarque para ver el precio total estimado en tiempo real.</small>
 </div>
 
 <div class="col-md-6">
 <div id="ResumenCotizacion" class="border rounded p-3 bg-light">
 <div class="d-flex justify-content-between"><span>Noches</span><strong id="C_Noches">0</strong></div>
 <div class="d-flex justify-content-between"><span>Subtotal habitación</span><strong id="C_SubHab">$0.00</strong></div>
 <div class="d-flex justify-content-between"><span>Servicios</span><strong id="C_SubServ">$0.00</strong></div>
 <hr/>
 <div class="d-flex justify-content-between"><span>Total estimado</span><strong id="C_Total">$0.00</strong></div>
 <small class="text-muted">Se usa la tarifa configurada por temporada y un recargo si la habitación incluye jacuzzi.</small>
 </div>
 </div>

 <div class="col-12">
 <button type="submit" class="btn btn-primary">Guardar</button>
 <a class="btn btn-secondary" href="@Url.Action("Index")">Volver</a>
 </div>
 
 <!-- Habitaciones disponibles para el rango (informativo) -->
 <div class="col-12 mt-4">
 <div class="d-flex justify-content-between align-items-center">
 <h5 class="mb-0">Habitaciones disponibles</h5>
 <button type="button" id="BtnBuscarDisp" class="btn btn-outline-primary btn-sm">Buscar</button>
 </div>
 <small class="text-muted">Use Entrada/Salida y Hotel para listar disponibles a continuación.</small>
 <div id="GridDisponibles" class="row mt-3 g-3"></div>
 </div>
 </form>
</div>
@section Scripts{
 <partial name="_ValidationScriptsPartial" />
 <script>
 const fmt = (v)=> new Intl.NumberFormat('en-US',{ style:'currency', currency:'USD'}).format(v||0);
 const form = document.getElementById('FormCrearHab');
 const qEntrada = document.getElementById('CotzEntrada');
 const qSalida = document.getElementById('CotzSalida');
 const qHotel = document.getElementById('HotelId');
 const qTipo = document.getElementById('Tipo');
 const qAme = document.getElementById('Amenidades');
 const contServicios = document.getElementById('ServiciosHotel');
 const cNoches = document.getElementById('C_Noches');
 const cSubHab = document.getElementById('C_SubHab');
 const cSubServ = document.getElementById('C_SubServ');
 const cTotal = document.getElementById('C_Total');
 const btnDisp = document.getElementById('BtnBuscarDisp');
 const grid = document.getElementById('GridDisponibles');
 const qNumero = document.getElementById('Numero');
 const qPisoHidden = document.getElementById('Piso');
 const qOcupadas = document.getElementById('Ocupadas');
 const hEntrada = document.getElementById('CotzEntradaHidden');
 const hSalida = document.getElementById('CotzSalidaHidden');

 function getHasJacuzzi(){
 const t = (qAme.value||'').toLowerCase();
 return t.includes('jacuzzi') || t.includes('jacuzi');
 }
 function noches(){
 const fe = new Date(qEntrada.value); const fs = new Date(qSalida.value);
 if (isNaN(fe) || isNaN(fs)) return0;
 const diff = (fs - fe)/(1000*60*60*24);
 return Math.max(0, Math.round(diff));
 }
 async function cargarServicios(){
 contServicios.innerHTML = '';
 const hid = qHotel.value;
 if (!hid){ return; }
 const res = await fetch(`@Url.Action("ServiciosHotel","Habitaciones")?hotelId=${hid}`);
 if (!res.ok) return;
 const data = await res.json();
 data.forEach(s=>{
 const id = `svc_${s.nombre}`;
 const wrap = document.createElement('div');
 wrap.className='form-check';
 wrap.innerHTML = `<input class="form-check-input svc-item" type="checkbox" id="${id}" data-precio="${s.precio}"> <label class="form-check-label" for="${id}">${s.nombre} (${fmt(s.precio)})</label>`;
 contServicios.appendChild(wrap);
 });
 contServicios.querySelectorAll('.svc-item').forEach(cb=> cb.addEventListener('change', actualizarCotizacion));
 }
 async function actualizarCotizacion(){
 const hid = qHotel.value; const tipo = qTipo.value; const fe = qEntrada.value; const fs = qSalida.value;
 if (!hid || !tipo || !fe || !fs){ cNoches.textContent='0'; cSubHab.textContent=fmt(0); cSubServ.textContent=fmt(0); cTotal.textContent=fmt(0); hEntrada.value=''; hSalida.value=''; limpiarHiddenServicios(); return; }
 const jq = getHasJacuzzi();
 const url = `@Url.Action("Quote","Habitaciones")?hotelId=${hid}&tipo=${tipo}&fechaEntrada=${fe}&fechaSalida=${fs}&hasJacuzzi=${jq}`;
 const res = await fetch(url);
 if (!res.ok){ cNoches.textContent='0'; cSubHab.textContent=fmt(0); cSubServ.textContent=fmt(0); cTotal.textContent=fmt(0); hEntrada.value=''; hSalida.value=''; limpiarHiddenServicios(); return; }
 const data = await res.json();
 const nochesVal = data.noches ||0; const subHab = data.subtotal ||0;
 let subServ =0; document.querySelectorAll('.svc-item:checked').forEach(cb=> subServ += Number(cb.getAttribute('data-precio'))||0);
 cNoches.textContent = nochesVal; cSubHab.textContent = fmt(subHab); cSubServ.textContent = fmt(subServ); cTotal.textContent = fmt(subHab + subServ);
 // mirror to hidden inputs for server
 hEntrada.value = fe; hSalida.value = fs;
 // regenerate hidden service inputs (svc_*)
 limpiarHiddenServicios();
 document.querySelectorAll('.svc-item:checked').forEach(cb=>{
 const h = document.createElement('input'); h.type='hidden'; h.name = cb.id; h.value='on'; form.appendChild(h);
 });
 }
 function limpiarHiddenServicios(){
 form.querySelectorAll('input[name^="svc_"]').forEach(x=>x.remove());
 }
 async function buscarDisponibles(){
 const fe = qEntrada.value; const fs = qSalida.value; const hid = qHotel.value || '';
 if (!fe || !fs){ grid.innerHTML = '<div class="col-12"><div class="alert alert-info">Seleccione Entrada y Salida.</div></div>'; return; }
 const url = `@Url.Action("GetDisponibles","Reservas")?fechaEntrada=${fe}&fechaSalida=${fs}&hotelId=${hid}`;
 const res = await fetch(url);
 if (!res.ok){ grid.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error obteniendo disponibilidad.</div></div>'; return; }
 const data = await res.json();
 grid.innerHTML = '';
 if (!data || data.length===0){ grid.innerHTML = '<div class="col-12"><div class="alert alert-warning">No hay habitaciones disponibles.</div></div>'; return; }
 data.forEach(item=>{
 const col = document.createElement('div'); col.className = 'col-md-4';
 col.innerHTML = `<div class="card h-100"><div class="card-body">
 <h5 class="card-title">Hab. ${item.numero} - ${item.tipo}</h5>
 <h6 class="card-subtitle mb-2 text-muted">${item.hotel}</h6>
 <p class="card-text mb-0">Precio promedio: $${item.precioPromedio}</p>
 </div></div>`;
 grid.appendChild(col);
 });
 }

 async function cargarNumeros(){
 const hid = qHotel.value; const tipo = qTipo.value;
 qNumero.innerHTML = '<option value="">-- seleccione tipo y hotel --</option>';
 qOcupadas.innerHTML = '<option>(sin datos)</option>';
 if (!hid || !tipo){ return; }
 const url = `@Url.Action("GetNumeros","Habitaciones")?hotelId=${hid}&tipo=${tipo}`;
 try{
 const res = await fetch(url);
 if(!res.ok) return;
 const data = await res.json();
 // disponibles
 qNumero.innerHTML = '';
 if(!data.disponibles || data.disponibles.length ===0){
 qNumero.innerHTML = '<option value="">(no hay números disponibles)</option>';
 }else{
 qNumero.insertAdjacentHTML('beforeend','<option value="">-- seleccione --</option>');
 data.disponibles.forEach(n=>{
 const opt = document.createElement('option');
 opt.value = n; opt.textContent = n; qNumero.appendChild(opt);
 });
 }
 // ocupadas
 qOcupadas.innerHTML='';
 if(data.ocupadas && data.ocupadas.length){
 data.ocupadas.forEach(n=>{
 const opt = document.createElement('option'); opt.textContent = n; qOcupadas.appendChild(opt);
 });
 }else{
 qOcupadas.innerHTML = '<option>(ninguna)</option>';
 }
 }catch{ /* ignore */ }
 }

 function syncPiso(){
 const num = parseInt(qNumero.value);
 if(!isNaN(num)){
 const piso = Math.floor(num /100);
 qPisoHidden.value = isFinite(piso) ? piso : '';
 } else {
 qPisoHidden.value = '';
 }
 }

 // eventos
 qHotel.addEventListener('change', ()=>{ cargarServicios(); actualizarCotizacion(); cargarNumeros(); });
 qTipo.addEventListener('change', ()=>{ actualizarCotizacion(); cargarNumeros(); });
 qAme.addEventListener('input', actualizarCotizacion);
 qEntrada.addEventListener('change', ()=>{ const d = new Date(qEntrada.value); if (!isNaN(d)){ d.setDate(d.getDate()+1); qSalida.min = d.toISOString().slice(0,10);} actualizarCotizacion(); });
 qSalida.addEventListener('change', ()=>{ actualizarCotizacion(); });
 btnDisp.addEventListener('click', buscarDisponibles);
 qNumero.addEventListener('change', syncPiso);
 form.addEventListener('submit', (e)=>{ actualizarCotizacion(); });
 // inicial
 cargarServicios(); actualizarCotizacion(); cargarNumeros();
 </script>
}