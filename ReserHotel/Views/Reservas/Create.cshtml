@model ReserHotel.Models.ViewModels.ReservaCreateViewModel
@using HotelSystem.Domain.Entities
@{
 ViewData["Title"] = "Crear Reserva";
}
<div class="container mt-4">
 <h2>Crear reserva</h2>

 @if (TempData["Error"] != null){<div class="alert alert-danger">@TempData["Error"]</div>}
 <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>
 
 <form asp-action="Create" method="post" class="row g-3">
 <!-- Datos requeridos del huésped -->
 <div class="col-12"><h5>Datos del huésped</h5></div>
 <div class="col-md-3">
 <label asp-for="Documento" class="form-label"></label>
 <input asp-for="Documento" class="form-control" inputmode="numeric" maxlength="8" pattern="\d{8}" />
 <span class="form-text">8 dígitos numéricos.</span>
 <span asp-validation-for="Documento" class="text-danger"></span>
 </div>
 <div class="col-md-5">
 <label asp-for="NombreCompleto" class="form-label"></label>
 <input asp-for="NombreCompleto" class="form-control" />
 <span asp-validation-for="NombreCompleto" class="text-danger"></span>
 </div>
 <div class="col-md-4">
 <label asp-for="Telefono" class="form-label"></label>
 <input asp-for="Telefono" class="form-control" inputmode="numeric" maxlength="9" pattern="\d{9}" />
 <span class="form-text">9 dígitos numéricos.</span>
 <span asp-validation-for="Telefono" class="text-danger"></span>
 </div>

 <!-- Filtro rápido de habitaciones (histórico) -->
 <div class="col-12 mt-4"><h5>Filtro rápido de habitaciones</h5></div>
 <div class="col-md-4">
 <label class="form-label">Hotel</label>
 <select id="QHotel" class="form-select">
 <option value="">-- seleccionar --</option>
 @foreach(var h in Model.Hoteles ?? Enumerable.Empty<Hotel>()){
 <option value="@h.Id">@h.Nombre</option>
 }
 </select>
 </div>
 <div class="col-md-4">
 <label class="form-label">Tipo</label>
 <select id="QTipo" class="form-select">
 <option value="">-- tipo --</option>
 @foreach (TipoHabitacion t in Enum.GetValues(typeof(TipoHabitacion))){
 <option value="@((int)t)">@t</option>
 }
 </select>
 </div>
 <div class="col-md-4">
 <label class="form-label">Capacidad mínima</label>
 <input id="QCapacidadMin" type="number" class="form-control" min="1" placeholder="Ej:2" />
 </div>
 <div class="col-md-6">
 <label class="form-label">Habitaciones disponibles</label>
 <select id="QDisponibles" class="form-select">
 <option value="">-- seleccione hotel y tipo --</option>
 </select>
 <span class="form-text">Se muestran habitaciones que nunca se reservaron.</span>
 </div>
 <div class="col-md-6">
 <label class="form-label">Habitaciones ocupadas</label>
 <select id="QOcupadas" class="form-select" multiple size="4" disabled>
 <option>(sin datos)</option>
 </select>
 </div>

 <!-- Datos de la reserva -->
 <div class="col-12"><h5>Datos de la reserva</h5></div>
 <div class="col-md-4">
 <label asp-for="FechaEntrada" class="form-label"></label>
 <input asp-for="FechaEntrada" class="form-control" type="date" min="@DateTime.Today.ToString("yyyy-MM-dd")" id="FechaEntrada" />
 <span asp-validation-for="FechaEntrada" class="text-danger"></span>
 </div>
 <div class="col-md-4">
 <label asp-for="FechaSalida" class="form-label"></label>
 <input asp-for="FechaSalida" class="form-control" type="date" min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" id="FechaSalida" />
 <span asp-validation-for="FechaSalida" class="text-danger"></span>
 </div>

 <input type="hidden" asp-for="HabitacionId" id="HabitacionId" />

 <!-- Servicios adicionales -->
 <div class="col-12"><h5>Servicios adicionales</h5></div>
 <div class="col-12">@Html.ValidationMessage("Servicios", new { @class = "text-danger" })</div>
 <div class="col-md-3 form-check">
 <input class="form-check-input" asp-for="Desayuno" id="Desayuno" />
 <label class="form-check-label" asp-for="Desayuno">Desayuno <span class="text-muted" id="priceDesayuno">$15.00</span></label>
 </div>
 <div class="col-md-3 form-check">
 <input class="form-check-input" asp-for="Spa" id="Spa" />
 <label class="form-check-label" asp-for="Spa">Spa <span class="text-muted" id="priceSpa">$50.00</span></label>
 </div>
 <div class="col-md-3 form-check">
 <input class="form-check-input" asp-for="Estacionamiento" id="Estacionamiento" />
 <label class="form-check-label" asp-for="Estacionamiento">Estacionamiento <span class="text-muted" id="priceEst">$10.00</span></label>
 </div>
 <div class="col-md-3 form-check">
 <input class="form-check-input" asp-for="LateCheckout" id="LateCheckout" />
 <label class="form-check-label" asp-for="LateCheckout">Late checkout <span class="text-muted" id="priceLate">$25.00</span></label>
 </div>

 <!-- Resumen -->
 <div class="col-12"><h5>Resumen</h5></div>
 <div class="col-md-8">
 <div id="liveSummary" class="border rounded p-3">
 <div class="d-flex justify-content-between"><span>Noches</span><strong id="sumNoches">0</strong></div>
 <div class="d-flex justify-content-between"><span>Habitación</span><strong id="sumHabitacion">-</strong></div>
 <div class="d-flex justify-content-between"><span>Precio por noche</span><strong id="sumPriceNight">$0.00</strong></div>
 <div class="d-flex justify-content-between"><span>Subtotal habitación</span><strong id="sumSubHab">$0.00</strong></div>
 <div class="d-flex justify-content-between"><span>Servicios</span><strong id="sumSubServ">$0.00</strong></div>
 <div class="d-flex justify-content-between"><span>Descuento</span><strong id="sumDesc">-</strong></div>
 <hr />
 <div class="d-flex justify-content-between"><span>Total</span><strong id="sumTotal">$0.00</strong></div>
 </div>
 <div class="form-check mt-2">
 <input class="form-check-input" type="checkbox" id="terms" required />
 <label class="form-check-label" for="terms">Acepto los términos y condiciones.</label>
 </div>
 </div>
 <div class="col-md-4">
 <div class="border rounded p-3 bg-light">
 <partial name="_ServiciosAdicionales" model="Model" />
 </div>
 </div>

 <div class="col-12">
 <button type="submit" class="btn btn-primary">Realizar reserva</button>
 </div>
 </form>
</div>
@section Scripts{
 <partial name="_ValidationScriptsPartial" />
 <script>
 const docInput = document.getElementById('Documento');
 const telInput = document.getElementById('Telefono');
 if(docInput){ docInput.addEventListener('input', ()=>{ docInput.value = docInput.value.replace(/[^\d]/g,'').slice(0,8); }); }
 if(telInput){ telInput.addEventListener('input', ()=>{ telInput.value = telInput.value.replace(/[^\d]/g,'').slice(0,9); }); }

 const fHotel = document.getElementById('QHotel');
 const fTipo = document.getElementById('QTipo');
 const fDisp = document.getElementById('QDisponibles');
 const fOcup = document.getElementById('QOcupadas');
 const fCapMin = document.getElementById('QCapacidadMin');
 const habHidden = document.getElementById('HabitacionId');
 const fEntrada = document.getElementById('FechaEntrada');
 const fSalida = document.getElementById('FechaSalida');

 const sumNoches = document.getElementById('sumNoches');
 const sumHabitacion = document.getElementById('sumHabitacion');
 const sumPriceNight = document.getElementById('sumPriceNight');
 const sumSubHab = document.getElementById('sumSubHab');
 const sumSubServ = document.getElementById('sumSubServ');
 const sumTotal = document.getElementById('sumTotal');

 const chkDes = document.getElementById('Desayuno');
 const chkSpa = document.getElementById('Spa');
 const chkEst = document.getElementById('Estacionamiento');
 const chkLate = document.getElementById('LateCheckout');

 const priceMap = { '1':35, '2':56, '3':84 }; // Simple, Doble, Suite en USD
 const tipoText = { '1': 'Simple', '2': 'Doble', '3': 'Suite' };
 const serviciosPrices = { Desayuno:15, Spa:50, Estacionamiento:10, LateCheckout:25 };

 function calcNoches(){
 try {
 const d1 = new Date(fEntrada.value);
 const d2 = new Date(fSalida.value);
 if(!fEntrada.value || !fSalida.value) return0;
 const ms = d2 - d1;
 const nights = Math.max(0, Math.ceil(ms / (1000*60*60*24)));
 return nights;
 } catch { return0; }
 }

 function formatUSD(v){ return `$${(v||0).toFixed(2)}`; }

 function serviciosSubtotal(){
 let total =0;
 if(chkDes && chkDes.checked) total += serviciosPrices.Desayuno;
 if(chkSpa && chkSpa.checked) total += serviciosPrices.Spa;
 if(chkEst && chkEst.checked) total += serviciosPrices.Estacionamiento;
 if(chkLate && chkLate.checked) total += serviciosPrices.LateCheckout;
 return total;
 }

 function updateSummary(){
 const tipo = fTipo.value || '';
 const nights = calcNoches();
 const priceNight = priceMap[tipo] ||0;
 const subHab = priceNight * nights;
 const subServ = serviciosSubtotal();
 sumNoches.textContent = nights;
 sumHabitacion.textContent = tipo ? `${tipoText[tipo]}` : '-';
 sumPriceNight.textContent = formatUSD(priceNight);
 sumSubHab.textContent = formatUSD(subHab);
 sumSubServ.textContent = formatUSD(subServ);
 sumTotal.textContent = formatUSD(subHab + subServ);
 }

 fHotel.addEventListener('change', ()=>{
 fDisp.innerHTML='<option>-- cargando --</option>';
 fOcup.innerHTML='<option>(sin datos)</option>';
 const hid = fHotel.value; const tipo = fTipo.value;
 if(!hid || !tipo){ fDisp.innerHTML='<option value="">-- seleccione hotel y tipo --</option>'; updateSummary(); return; }
 const url = `@Url.Action("QuickNumbersHistory")?hotelId=${hid}&tipo=${tipo}`;
 fetch(url)
 .then(res=>{ if(!res.ok) throw'Error'; return res.json(); })
 .then(data=>{
 fDisp.innerHTML='';
 const disp = (data.disponibles||[]).filter(x=> !fCapMin.value || x.capacidad >= parseInt(fCapMin.value));
 if(disp.length===0){ fDisp.innerHTML='<option value="">(no disponibles)</option>'; }
 else{
 fDisp.insertAdjacentHTML('beforeend','<option value="">-- seleccione --</option>');
 disp.forEach(x=>{ fDisp.insertAdjacentHTML('beforeend',`<option value="${x.id}" data-num="${x.numero}" data-cap="${x.capacidad}">${x.numero} (cap:${x.capacidad})</option>`); });
 }
 fOcup.innerHTML='';
 if(data.ocupadas && data.ocupadas.length){ data.ocupadas.forEach(n=> fOcup.insertAdjacentHTML('beforeend',`<option>${n}</option>`)); }
 else fOcup.innerHTML='<option>(ninguna)</option>';
 updateSummary();
 })
 .catch(err=>{ fDisp.innerHTML='<option>Error</option>'; });
 });

 fTipo.addEventListener('change', ()=>{
 fDisp.innerHTML='<option>-- cargando --</option>';
 fOcup.innerHTML='<option>(sin datos)</option>';
 const hid = fHotel.value; const tipo = fTipo.value;
 if(!hid || !tipo){ fDisp.innerHTML='<option value="">-- seleccione hotel y tipo --</option>'; updateSummary(); return; }
 const url = `@Url.Action("QuickNumbersHistory")?hotelId=${hid}&tipo=${tipo}`;
 fetch(url)
 .then(res=>{ if(!res.ok) throw'Error'; return res.json(); })
 .then(data=>{
 fDisp.innerHTML='';
 const disp = (data.disponibles||[]).filter(x=> !fCapMin.value || x.capacidad >= parseInt(fCapMin.value));
 if(disp.length===0){ fDisp.innerHTML='<option value="">(no disponibles)</option>'; }
 else{
 fDisp.insertAdjacentHTML('beforeend','<option value="">-- seleccione --</option>');
 disp.forEach(x=>{ fDisp.insertAdjacentHTML('beforeend',`<option value="${x.id}" data-num="${x.numero}" data-cap="${x.capacidad}">${x.numero} (cap:${x.capacidad})</option>`); });
 }
 fOcup.innerHTML='';
 if(data.ocupadas && data.ocupadas.length){ data.ocupadas.forEach(n=> fOcup.insertAdjacentHTML('beforeend',`<option>${n}</option>`)); }
 else fOcup.innerHTML='<option>(ninguna)</option>';
 updateSummary();
 })
 .catch(err=>{ fDisp.innerHTML='<option>Error</option>'; });
 });

 fCapMin.addEventListener('input', ()=>{
 fDisp.innerHTML='<option>-- cargando --</option>';
 fOcup.innerHTML='<option>(sin datos)</option>';
 const hid = fHotel.value; const tipo = fTipo.value;
 if(!hid || !tipo){ fDisp.innerHTML='<option value="">-- seleccione hotel y tipo --</option>'; updateSummary(); return; }
 const url = `@Url.Action("QuickNumbersHistory")?hotelId=${hid}&tipo=${tipo}`;
 fetch(url)
 .then(res=>{ if(!res.ok) throw'Error'; return res.json(); })
 .then(data=>{
 fDisp.innerHTML='';
 const disp = (data.disponibles||[]).filter(x=> !fCapMin.value || x.capacidad >= parseInt(fCapMin.value));
 if(disp.length===0){ fDisp.innerHTML='<option value="">(no disponibles)</option>'; }
 else{
 fDisp.insertAdjacentHTML('beforeend','<option value="">-- seleccione --</option>');
 disp.forEach(x=>{ fDisp.insertAdjacentHTML('beforeend',`<option value="${x.id}" data-num="${x.numero}" data-cap="${x.capacidad}">${x.numero} (cap:${x.capacidad})</option>`); });
 }
 fOcup.innerHTML='';
 if(data.ocupadas && data.ocupadas.length){ data.ocupadas.forEach(n=> fOcup.insertAdjacentHTML('beforeend',`<option>${n}</option>`)); }
 else fOcup.innerHTML='<option>(ninguna)</option>';
 updateSummary();
 })
 .catch(err=>{ fDisp.innerHTML='<option>Error</option>'; });
 });

 fDisp.addEventListener('change', ()=>{
 const opt = fDisp.selectedOptions[0];
 if(opt && opt.value){ habHidden.value = opt.value; }
 updateSummary();
 });

 fEntrada.addEventListener('change', updateSummary);
 fSalida.addEventListener('change', updateSummary);
 if(chkDes) chkDes.addEventListener('change', updateSummary);
 if(chkSpa) chkSpa.addEventListener('change', updateSummary);
 if(chkEst) chkEst.addEventListener('change', updateSummary);
 if(chkLate) chkLate.addEventListener('change', updateSummary);

 updateSummary();
 </script>
}}